<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Orkney ANM Curtailment Forecast</title>
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!-- Compiled and minified JavaScript -->
  <link href="https://fonts.googleapis.com/css?family=Cabin" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
  <div class="navbar-fixed">
    <nav>
      <div class="nav-wrapper indigo">
        <a href="/" class="brand-logo center">Curtailment Forecast for the Orkney ANM</a>
        <ul id="nav-mobile" class="right">
          <li><a href="http://curtailment.net">Graph Tool</a></li>
          <li><a class=" modal-trigger" href="#modal1">About this page</a></li>
        </ul>
      </div>
    </nav>
  </div>

  <div  class="container">

    <!-- Modal Structure -->
    <div id="modal1" class="modal">
      <div class="modal-content">
        <h2 id="aboutthispage">About this page.</h2>

        <h4 id="_whatisthis_"><em>What is this?</em></h4>

        <p>A forecast of how likely it is that curtailment of generators will be issued in the Orkney ANM. Like a weather forecast, but just with curtailment instead. It can be used to get an overview of the next few days, and the idea is to incoorperate this service with power hungry devices, to schedule the tasks for times where energy is in excess. Currently it is simply a demonstration of our models and hopefully it can help make the ANM curtailment system a little more understandable for the orcadians affected by it.</p>

        <h4 id="_howdoesitwork_"><em>How does it work?</em></h4>

        <p>Through a bunch of data collection, we have created a (neural network-based) programmme that estimates curtailment based on wind speeds, day-of-week, and time-of-day. We then combine this model with the weather forecasts for Westray Airfield generated by the <a href="https://www.metoffice.gov.uk/weather/forecast/gftcsumwq#?date=2019-05-15">UK Met Office</a> to make forecasts of whether curtailment will happen a certain times in the future. The data for training the model have been collected through the <a href="https://www.ssen.co.uk/ANMGeneration/">SSE's ANM website</a>, and wind speed data generated by a single turbine in Orkney.</p>
        <p>The risk assesment is done statistically by looking at the historical chance of curtailment according to model output. This means that when the forecasts says "0% risk of curtailment", it simply means that historically there has been no curtailment when the model gave this output. But there's a first time for everything.</p>

        <h4 id="_whomadethis_"><em>Who made this?</em></h4>

        <p>This website is a  by-product of a MSc-thesis project by <a href="mailto:niec@itu.dk">Niels Ørbæk Christensen</a> at the IT University of Copenhagen, made in collaboration with the <a href="http://orkneycloud.org/">Orkney Cloud</a> project, invisioning community-led data services in Orkney. </p>
        <p>You should also check out the ANM graph tool over at <a href="http://curtailment.net">http://curtailment.net</a>.
        <div class="modal-footer">
          <a href="#!" class="modal-close waves-effect waves-green btn-flat">Ok!</a>
        </div>
      </div>
    </div>

    <h1>Upcoming days</h1>
    <div id="graph-wrapper">
      <canvas id="long-term-graph" width="100%" height="400px"></canvas>
    </div>

  </div>
</div>

<div class="load-modal"><div class="lds-grid loader"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>

<script>
(async () => {
  $(".load-modal").fadeIn()

  $.ajax("http://curtailment.net/json/2019-05-01/2019-05-07").done(p => {
    obj = JSON.parse(p)
    deltas = parseDelta(obj.columns, obj.index, obj.data)
    obj.index = obj.index.map((t) => moment(t))
    makeDeltaGraph(obj.index,deltas)
    $(".load-modal").fadeOut()
  })
})();

moment.defaultFormat = "HH:mm DD.MM.YYYY"
const zoneNames = ["Core Zone: Curtailed", "Zone 1: Curtailed", "Zone 1A: Curtailed", "Zone 2: Curtailed", "Zone 2A: Curtailed", "Zone 2B: Curtailed", "Zone 3: Curtailed", "Zone 4: Curtailed", "Zone 4A: Curtailed"]


function parseDelta(cols,index,rows) {
  genIndex = cols.indexOf("Generation")
  demIndex = cols.indexOf("Demand")
  deltas = []
  rows.forEach((r) => deltas.push(r[genIndex]-r[demIndex]))
  return deltas
}

var scaleList = (l) => {
  while(l.length > 1000) {
    l = l.filter((_,i) => i%2 == 0)
  }
  return l
}

function makeDeltaGraph(xs,ys) {
  ctx = $('#long-term-graph')

  xs = scaleList(xs)
  ys = scaleList(ys)

  // Create gradient
  grd = document.getElementById('long-term-graph').getContext("2d").createLinearGradient(150.000, 300.000, 150.000, 0.000);

  // Add colors
  grd.addColorStop(0.000, 'rgba(255, 0, 0, 1.000)');
  grd.addColorStop(0.500, 'rgba(255, 255, 0, 1.000)');
  grd.addColorStop(1.000, 'rgba(255, 0, 0, 1.000)');

  var myChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: xs,
      datasets: [{
        label: 'Generation relative to Demand',
        data: ys,
        borderColor:               'rgba(0, 0, 0, 0.9)',
        backgroundColor:           'rgba(0, 0, 0, 0.250)',
        pointRadius: 1,
        pointHoverRadius: 5
      }]
    },
    options: {
      scales: {
        xAxes: [{
          type: 'time',
          time: {
            unit: 'hour',
            stepSize: 12,
            displayFormats: {
              hour: "ddd HH:mm"
            }
          },
          ticks: {
            source: "auto"
          }
        }],
        yAxes: [{
          ticks: {
            min: -25,
            max: 25,
            callback: function(label, index, labels) {
              return label+'MW';
            }
          }
        }]
      },
      responsive:true,
      maintainAspectRatio: false,
      tooltips: {
        callbacks: {
          label: function(tooltipItem, chart) {
            return Math.round(tooltipItem.value*100)/100 + "MW";
          }
        }
      }
    }
  });
}

function getCol(zoneName, cols, rows){
  i = cols.indexOf(zoneName)
  is = [i,i+1]
  row
}

function getColorClass(p) {
  if(p > 0.75) { return "red" }
  if(p > 0.45) { return "orange"}
  else {return "teal"}
}

function getColor(value){
  //value from 0 to 1
  var hue=((1-value)*120).toString(10);
  return ["hsl(",hue,",100%,50%)"].join("");
}

$(document).ready(function(){
  $('.modal').modal();
});

</script>
</body>
</html>
