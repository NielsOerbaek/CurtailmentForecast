<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Orkney ANM Curtailment Forecast</title>
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!-- Compiled and minified JavaScript -->
  <link href="https://fonts.googleapis.com/css?family=Cabin" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js"></script>
</head>
<body>
  <div class="navbar-fixed">
    <nav>
      <div class="nav-wrapper indigo">
        <a href="/" class="brand-logo center">Curtailment Forecast for the Orkney ANM</a>
        <ul id="nav-mobile" class="right">
          <li><a href="http://curtailment.net">Graph Tool</a></li>
          <li><a class=" modal-trigger" href="#modal1">About this page</a></li>
        </ul>
      </div>
    </nav>
  </div>

  <div  class="container">

    <!-- Modal Structure -->
    <div id="modal1" class="modal">
      <div class="modal-content">
        <h2 id="aboutthispage">About this page.</h2>

        <h4 id="_whatisthis_"><em>What is this?</em></h4>

        <p>A forecast of how likely it is that curtailment of generators will be issued in the Orkney ANM. Like a weather forecast, but just with curtailment instead. It can be used to get an overview of the next few days, and the idea is to incoorperate this service with power hungry devices, to schedule the tasks for times where energy is in excess. Currently it is simply a demonstration of our models and hopefully it can help make the ANM curtailment system a little more understandable for the orcadians affected by it.</p>

        <h4 id="_howdoesitwork_"><em>How does it work?</em></h4>

        <p>Through a bunch of data collection, we have created a (neural network-based) programmme that estimates curtailment based on wind speeds, day-of-week, and time-of-day. We then combine this model with the weather forecasts for Westray Airfield generated by the <a href="https://www.metoffice.gov.uk/weather/forecast/gftcsumwq#?date=2019-05-15">UK Met Office</a> to make forecasts of whether curtailment will happen a certain times in the future. The data for training the model have been collected through the <a href="https://www.ssen.co.uk/ANMGeneration/">SSE's ANM website</a>, and the wind speed data used have been generated by the ERE turbine on Eday.</p>
        <p>The risk assesment is done statistically by looking at the historical chance of curtailment according to model output. This means that when the forecasts says "0% risk of curtailment", it simply means that historically there has been no curtailment when the model gave this output. But there's a first time for everything.</p>

        <h4 id="_whomadethis_"><em>Who made this?</em></h4>

        <p>This website is a  by-product of a MSc-thesis project by <a href="mailto:niec@itu.dk">Niels Ørbæk Christensen</a> at the IT University of Copenhagen, made in collaboration with the <a href="http://orkneycloud.org/">Orkney Cloud</a> project, invisioning community-led data services in Orkney. </p>
        <p>You should also check out the ANM graph tool over at <a href="http://curtailment.net">http://curtailment.net</a>.
        <p>The author would like to give thanks to Andrew and Clive of Eday Renewable Energy Ltd, for allowing us to use the wind data from their turbine.</p>
        <div class="modal-footer">
          <a href="#!" class="modal-close waves-effect waves-green btn-flat">Ok!</a>
        </div>
      </div>
    </div>

    <div id="forecasts">
      <h1>Today's forecast</h1>
      <div class="single-day day-0">
        <h2></h2>
        <div class="times">

        </div>
      </div>

      <hr/>
      <h1>Upcoming days</h1>
      <div id="graph-wrapper">
        <canvas id="long-term-graph" width="100%" height="300px"></canvas>
      </div>
      <div class="single-day day-1">
        <h2></h2>
        <div class="times">

        </div>
      </div>
      <div class="single-day day-2">
        <h2></h2>
        <div class="times">

        </div>
      </div>
      <div class="single-day day-3">
        <h2></h2>
        <div class="times">

        </div>
      </div>
      <div class="single-day day-4">
        <h2></h2>
        <div class="times">

        </div>
      </div>
    </div>
  </div>
</div>

<div class="load-modal"><div class="lds-grid loader"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>

<script>
(async () => {
  $(".load-modal").fadeIn()
  const model = await tf.loadLayersModel("data/WT-Percep-ERE/model.json");
  $.ajax(apiUrl).done(p => {
    forecasts = parseAndPredict(p, model)
    renderForecast(forecasts)
    makeGraph(forecasts)
    $(".load-modal").fadeOut()
  })
})();

const apiUrl = "http://datapoint.metoffice.gov.uk/public/data/val/wxfcs/all/json/354165?res=3hourly&key=b3bc673f-ff3c-40e7-9b50-dca48be4a2b1"
moment.defaultFormat = "HH:mm DD.MM.YYYY"
const mph_to_mps = 0.44704
const pred_to_risk = [ 0,0,0.0,0.0,0.0,0.004700352526439483,0.013785790031813362,0.07435197817189632,0.24439461883408073,0.484375,0.588715953307393,0.7629255989911727,0.811217510259918,0.7034068136272545,0.6620370370370371,0.6879194630872483,0.6879194630872483,0.6879194630872483,0.6879194630872483,0.6879194630872483,0.6879194630872483]


function parseAndPredict(p, model) {
  days = p.SiteRep.DV.Location.Period
  forecasts = []
  days.forEach((day,i) => {
    sameDay = new Object()
    sameDay.date =  moment(day.value, "YYYY-MM-DD[Z]")
    sameDay.times = []
    day.Rep.forEach((t,i) => {
      time = new Object()
      time.date = sameDay.date.clone()
      time.date.hour(t["$"]/60)
      time.speed = t.S*mph_to_mps
      time.weekday = time.date.isoWeekday()
      time.hour = time.date.hour()+1
      time.prediction = model.predict(tf.tensor2d([[time.speed,time.weekday,time.hour]])).dataSync()[0]
      time.risk = getRisk(time.prediction)
      sameDay.times.push(time)
    })
    forecasts.push(sameDay)
  })
  return forecasts
}

function renderForecast(fs) {
  fs.forEach((d,i) => {
    $("#forecasts .single-day.day-"+i+" h2").html(d.date.format("dddd, MMM Do"))
    $day = $("#forecasts .single-day.day-"+i+" .times")
    d.times.forEach((t,i) => {
      if(moment().subtract(3,"hours") < t.date) {
        $time = $("<div class='single-time card-panel' style='background-color:"+getColor(t.risk)+"'></div>").appendTo($day)
        $time.append("<h4>"+t.date.format("HH:mm")+"</h4>")
        $time.append("<div class='risk-digits'>"+parseInt(t.risk*100)+"%<br/><div class='risk-text'>risk of curtailment</div></div>")
        $time.append("<div class='wind-speed'>Winds: "+t.speed.toFixed(1)+" m/s</div>")
        //$time.append("<div class='risk-bar' style='height:"+parseInt(t.prediction*100)+"%'</div>")
      } else {
        console.log("Past:", t.date.format("ddd HH:mm"), parseInt(t.risk*100) + "% Risk")
      }
    })
  })
}

function getRisk(pred){
  //Wohooo Linear Interpolation!
  x = (pred-0.025)*20
  x0 = Math.floor(x)
  x1 = Math.ceil(x)
  y0 = pred_to_risk[x0]
  y1 = pred_to_risk[x1]
  risk = (y0*(x1-x)+y1*(x-x0))/(x1-x0)
  return risk
}

function makeGraph(fs) {
  ctx = $('#long-term-graph')

  xs = []
  ys = []

  fs.forEach((d) => {
    d.times.forEach((t) => {
      xs.push(t.date)
      ys.push(parseInt(t.risk*100))
    })
  })

  // Create gradient
  grd = document.getElementById('long-term-graph').getContext("2d").createLinearGradient(150.000, 300.000, 150.000, 0.000);

  // Add colors
  grd.addColorStop(0.000, 'rgba(0, 255, 0, 1.000)');
  grd.addColorStop(0.500, 'rgba(255, 255, 0, 1.000)');
  grd.addColorStop(1.000, 'rgba(255, 0, 0, 1.000)');

  var myChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: xs,
      datasets: [{
        label: 'Risk of Curtailment',
        data: ys,
        borderColor:               grd,
        pointBorderColor:          grd,
        pointBackgroundColor:      "rgba(0, 0, 0, 0.65)",
        pointHoverBackgroundColor: grd,
        pointHoverBorderColor:     grd,
        backgroundColor:           'rgba(0, 0, 0, 0.05)'
      }]
    },
    options: {
      scales: {
        xAxes: [{
          type: 'time',
          time: {
            unit: 'hour',
            stepSize: 12,
            displayFormats: {
              hour: "ddd HH:mm"
            }
          },
          ticks: {
            source: "auto"
          }
        }],
        yAxes: [{
          ticks: {
            min: 0,
            max: 100,
            callback: function(label, index, labels) {
              return label+'%';
            }
          }
        }]
      },
      responsive:true,
      maintainAspectRatio: false,
      tooltips: {
        callbacks: {
          label: function(tooltipItem, chart) {
            return " Curtailment risk: " + tooltipItem.value + "%";
          }
        }
      }
    }
  });
}

function getColorClass(p) {
  if(p > 0.75) { return "red" }
  if(p > 0.45) { return "orange"}
  else {return "teal"}
}

function getColor(value){
  //value from 0 to 1
  var hue=((1-value)*120).toString(10);
  return ["hsl(",hue,",100%,50%)"].join("");
}

$(document).ready(function(){
  $('.modal').modal();
});

</script>
</body>
</html>
